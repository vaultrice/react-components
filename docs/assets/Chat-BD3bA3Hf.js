import{j as s}from"./jsx-runtime-D_zvdyIk.js";import{r as c}from"./iframe-BjnNhCKo.js";import"./theme-BHdC5j6d.js";import{e as Q}from"./useNonLocalStorage-D4KNi1vk.js";import{o as W,d as X}from"./Presence-D46avnJM.js";const Z=(a,t,i)=>{const[o,u,d,,j,h,x]=Q(a,t,i);return[u?.value||[],{push:async(m,y)=>{try{const l=await o.push(t,m,y);d(l)}catch(l){h(l)}},splice:async(m,y,l,C)=>{try{const N=await o.splice(t,m,y,l,C);d(N)}catch(N){h(N)}},setArray:async(m,y)=>{try{const l=await o.setItem(t,m,y);d(l)}catch(l){h(l)}}},j,x]};let q;typeof crypto<"u"&&typeof crypto.randomUUID=="function"?q=()=>crypto.randomUUID():q=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,a=>{const t=Math.random()*16|0;return(a==="x"?t:t&3|8).toString(16)});const G=(a,t=!0)=>{const i=new Date(a),o=new Date,u=i.toDateString()===o.toDateString();return u&&t?i.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):u?"Today":i.toLocaleDateString()},H=(a,t)=>{if(!t)return!1;const i=a.timestamp-t.timestamp,o=300*1e3;return a.user===t.user&&i<o},ee=(a,t,i,o,u,d=!1,j)=>{const h=t&&u?u:{name:a.user,avatarUrl:a.avatarUrl},x=t?"(You)":a.user,m=j||X;return s.jsxs("div",{className:`vaultrice-chat-message ${t?"vaultrice-chat-message-own":""} ${d?"vaultrice-chat-message-grouped":""}`,children:[i&&!d&&s.jsx("div",{className:"vaultrice-chat-avatar",children:m(h,t)}),i&&d&&s.jsx("div",{className:"vaultrice-chat-avatar vaultrice-chat-avatar-spacer"}),s.jsxs("div",{className:"vaultrice-chat-message-content",children:[!d&&s.jsx("div",{className:"vaultrice-chat-message-user",children:x}),s.jsx("div",{className:"vaultrice-chat-message-text",children:a.message}),o&&s.jsx("div",{className:"vaultrice-chat-message-timestamp",children:G(a.timestamp)})]})]})},te=({users:a})=>{if(a.length===0)return null;const t=a.length===1?`${a[0]} is typing...`:a.length===2?`${a[0]} and ${a[1]} are typing...`:`${a.slice(0,-1).join(", ")} and ${a[a.length-1]} are typing...`;return s.jsxs("div",{className:"vaultrice-chat-typing",children:[s.jsxs("div",{className:"vaultrice-chat-typing-dots",children:[s.jsx("span",{}),s.jsx("span",{}),s.jsx("span",{})]}),s.jsx("span",{className:"vaultrice-chat-typing-text",children:t})]})},ae=({id:a,user:t,auth:i,onMessage:o,onSendReady:u,placeholder:d="Type a message...",showTimestamps:j=!0,showUserAvatars:h=!0,autoScroll:x=!0,credentials:m,instanceOptions:y,messageFilter:l,renderMessage:C,renderAvatar:N,disabled:R=!1,persistMessages:w=!1,messageHistoryLimit:U=100})=>{const[v,$]=c.useState([]),[A,_]=c.useState(!1),[I,K]=c.useState(""),[L,S]=c.useState([]),D=c.useRef(null),P=c.useRef(null),M=c.useRef(u),O=c.useRef(null),E=c.useRef(null),[T,{push:V,splice:k},,b]=w?Z(a,"chat-history",{credentials:m,instanceOptions:y,bind:!1}):[[],{push:async()=>{},splice:async()=>{}},null,!1];c.useEffect(()=>{if(!(A||!w||b||!T||T.length===0)&&T&&Array.isArray(T)){const e=T.filter(r=>r&&typeof r=="object"&&"id"in r&&"user"in r&&"message"in r&&"timestamp"in r).sort((r,n)=>r.timestamp-n.timestamp);$(e),_(!0)}},[w,T,b,A]);const Y=c.useCallback(e=>{if(e.type==="typing"){(e.userId?e.userId===t.id:e.user===t.name)||(S(n=>[...n.filter(g=>g!==e.user),e.user]),O.current&&clearTimeout(O.current),O.current=setTimeout(()=>{S(n=>n.filter(f=>f!==e.user))},3e3));return}if(!(l&&!l(e))){if(e.type==="chat"&&e.user&&e.message){S(n=>(e.userId?e.userId===t.id:e.user===t.name)?n.filter(g=>g!==t.name):n.filter(g=>g!==e.user));const r={id:q(),user:e.user,message:e.message,timestamp:e.timestamp||Date.now(),userId:e.userId,avatarUrl:e.avatarUrl,type:e.messageType||"message"};$(n=>[...n,r])}o&&o(e)}},[l,o,t.name,t.id]),[,p]=W(a,Y,{credentials:m,instanceOptions:y});c.useEffect(()=>{E.current=p},[p]),c.useEffect(()=>{M.current=u},[u]),c.useEffect(()=>{p&&M.current&&M.current(p)},[p]),c.useEffect(()=>{x&&D.current&&D.current.scrollIntoView({behavior:"smooth"})},[v,x]);const J=c.useCallback(async()=>{if(I.trim()&&p&&!R){const e={type:"chat",user:t.name,message:I.trim(),timestamp:Date.now(),userId:t.id,avatarUrl:t.avatarUrl||void 0},r={id:q(),user:e.user,message:e.message,timestamp:e.timestamp,userId:e.userId,avatarUrl:e.avatarUrl,type:"message"};try{let n=i;if(i?.getIdentityToken){const f=await i.getIdentityToken();n={...i,identityToken:f}}if(p(e,n),w&&V&&(await V(r),v.length>=U&&k)){const f=v.length+1-U;f>0&&await k(0,f)}K("")}catch(n){console.error("Failed to send message:",n)}}},[I,p,R,t,i,w,V,k,U,v.length]),z=e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),J())},B=e=>{K(e.target.value),E.current&&E.current({type:"typing",user:t.name,userId:t.id,timestamp:Date.now()})},F=C||((e,r,n)=>ee(e,r,h,j,t,n,N));return s.jsxs("div",{className:"vaultrice-chat",children:[s.jsxs("div",{className:"vaultrice-chat-messages",ref:P,children:[b?s.jsx("div",{className:"vaultrice-chat-loading",children:s.jsx("div",{className:"vaultrice-chat-loading-text",children:"Loading chat history..."})}):v.length===0?s.jsxs("div",{className:"vaultrice-chat-empty",children:[s.jsx("div",{className:"vaultrice-chat-empty-text",children:"No messages yet"}),s.jsx("div",{className:"vaultrice-chat-empty-subtext",children:"Start the conversation!"})]}):v.map((e,r)=>{const n=e.userId?e.userId===t.id:e.user===t.name,f=r>0?v[r-1]:null,g=H(e,f);return s.jsx("div",{children:F(e,n,g)},e.id)}),L.length>0&&s.jsx(te,{users:L}),s.jsx("div",{ref:D})]}),s.jsxs("div",{className:"vaultrice-chat-input-container",children:[s.jsx("input",{type:"text",className:"vaultrice-chat-input",value:I,onChange:B,onKeyDown:z,placeholder:d,disabled:R||!p||b}),s.jsx("button",{className:"vaultrice-chat-send-button",onClick:J,disabled:R||!I.trim()||!p||b,children:"Send"})]})]})};ae.__docgenInfo={description:"",methods:[],displayName:"Chat",props:{id:{required:!0,tsType:{name:"string"},description:""},user:{required:!0,tsType:{name:"User"},description:""},onMessage:{required:!1,tsType:{name:"signature",type:"function",raw:"(msg: JSONObj) => void",signature:{arguments:[{type:{name:"JSONObj"},name:"msg"}],return:{name:"void"}}},description:""},onSendReady:{required:!1,tsType:{name:"signature",type:"function",raw:"(send: (msg: any) => void) => void",signature:{arguments:[{type:{name:"signature",type:"function",raw:"(msg: any) => void",signature:{arguments:[{type:{name:"any"},name:"msg"}],return:{name:"void"}}},name:"send"}],return:{name:"void"}}},description:""},placeholder:{required:!1,tsType:{name:"string"},description:"",defaultValue:{value:"'Type a message...'",computed:!1}},showTimestamps:{required:!1,tsType:{name:"boolean"},description:"",defaultValue:{value:"true",computed:!1}},showUserAvatars:{required:!1,tsType:{name:"boolean"},description:"",defaultValue:{value:"true",computed:!1}},autoScroll:{required:!1,tsType:{name:"boolean"},description:"",defaultValue:{value:"true",computed:!1}},credentials:{required:!1,tsType:{name:"Credentials"},description:""},instanceOptions:{required:!1,tsType:{name:"InstanceOptions"},description:""},messageFilter:{required:!1,tsType:{name:"signature",type:"function",raw:"(msg: any) => boolean",signature:{arguments:[{type:{name:"any"},name:"msg"}],return:{name:"boolean"}}},description:""},renderMessage:{required:!1,tsType:{name:"signature",type:"function",raw:"(msg: ChatMessage, isOwnMessage: boolean) => ReactNode",signature:{arguments:[{type:{name:"ChatMessage"},name:"msg"},{type:{name:"boolean"},name:"isOwnMessage"}],return:{name:"ReactNode"}}},description:""},renderAvatar:{required:!1,tsType:{name:"signature",type:"function",raw:"(user: any, isOwnConnection?: boolean) => ReactNode",signature:{arguments:[{type:{name:"any"},name:"user"},{type:{name:"boolean"},name:"isOwnConnection"}],return:{name:"ReactNode"}}},description:"Custom avatar renderer function for chat messages."},disabled:{required:!1,tsType:{name:"boolean"},description:"",defaultValue:{value:"false",computed:!1}},persistMessages:{required:!1,tsType:{name:"boolean"},description:"If true, messages will be persisted using Vaultrice",defaultValue:{value:"false",computed:!1}},messageHistoryLimit:{required:!1,tsType:{name:"number"},description:"",defaultValue:{value:"100",computed:!1}},auth:{required:!1,tsType:{name:"UserAuthSettings"},description:"Optional object containing authentication credentials for user verification."}}};export{ae as C};
