import{j as s}from"./jsx-runtime-D_zvdyIk.js";import{r as i}from"./iframe-CcyhuIVe.js";import"./theme-BHdC5j6d.js";import{e as Q}from"./useNonLocalStorage-WQFKiGvU.js";import{o as W,d as X}from"./Presence-DntoYNaJ.js";const Z=(a,t,c)=>{const[u,o,d,,j,y,g]=Q(a,t,c);return[o?.value||[],{push:async(m,f)=>{try{const l=await u.push(t,m,f);d(l)}catch(l){y(l)}},splice:async(m,f,l,C)=>{try{const T=await u.splice(t,m,f,l,C);d(T)}catch(T){y(T)}},setArray:async(m,f)=>{try{const l=await u.setItem(t,m,f);d(l)}catch(l){y(l)}}},j,g]};let q;typeof crypto<"u"&&typeof crypto.randomUUID=="function"?q=()=>crypto.randomUUID():q=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,a=>{const t=Math.random()*16|0;return(a==="x"?t:t&3|8).toString(16)});const G=(a,t=!0)=>{const c=new Date(a),u=new Date,o=c.toDateString()===u.toDateString();return o&&t?c.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):o?"Today":c.toLocaleDateString()},H=(a,t)=>{if(!t)return!1;const c=a.timestamp-t.timestamp,u=300*1e3;return a.user===t.user&&c<u},ee=(a,t,c,u,o,d=!1,j)=>{const y=t&&o?o:{name:a.user,avatarUrl:a.avatarUrl},g=t?"(You)":a.user,m=j||X;return s.jsxs("div",{className:`vaultrice-chat-message ${t?"vaultrice-chat-message-own":""} ${d?"vaultrice-chat-message-grouped":""}`,children:[c&&!d&&s.jsx("div",{className:"vaultrice-chat-avatar",children:m(y,t)}),c&&d&&s.jsx("div",{className:"vaultrice-chat-avatar vaultrice-chat-avatar-spacer"}),s.jsxs("div",{className:"vaultrice-chat-message-content",children:[!d&&s.jsx("div",{className:"vaultrice-chat-message-user",children:g}),s.jsx("div",{className:"vaultrice-chat-message-text",children:a.message}),u&&s.jsx("div",{className:"vaultrice-chat-message-timestamp",children:G(a.timestamp)})]})]})},te=({users:a})=>{if(a.length===0)return null;const t=a.length===1?`${a[0]} is typing...`:a.length===2?`${a[0]} and ${a[1]} are typing...`:`${a.slice(0,-1).join(", ")} and ${a[a.length-1]} are typing...`;return s.jsxs("div",{className:"vaultrice-chat-typing",children:[s.jsxs("div",{className:"vaultrice-chat-typing-dots",children:[s.jsx("span",{}),s.jsx("span",{}),s.jsx("span",{})]}),s.jsx("span",{className:"vaultrice-chat-typing-text",children:t})]})},ae=({id:a,user:t,auth:c,onMessage:u,onSendReady:o,placeholder:d="Type a message...",showTimestamps:j=!0,showUserAvatars:y=!0,autoScroll:g=!0,credentials:m,instanceOptions:f,messageFilter:l,renderMessage:C,renderAvatar:T,disabled:R=!1,persistMessages:N=!1,messageHistoryLimit:S=100})=>{const[h,A]=i.useState([]),[k,_]=i.useState(!1),[w,K]=i.useState(""),[L,U]=i.useState([]),D=i.useRef(null),P=i.useRef(null),M=i.useRef(o),O=i.useRef(null),E=i.useRef(null),[x,{push:V,splice:$},,b]=N?Z(a,"chat-history",{credentials:m,instanceOptions:f,bind:!1}):[[],{push:async()=>{},splice:async()=>{}},null,!1];i.useEffect(()=>{if(!(k||!N||b||!x||x.length===0)&&x&&Array.isArray(x)){const e=x.filter(r=>r&&typeof r=="object"&&"id"in r&&"user"in r&&"message"in r&&"timestamp"in r).sort((r,n)=>r.timestamp-n.timestamp);A(e),_(!0)}},[N,x,b,k]);const Y=i.useCallback(e=>{if(e.type==="typing"){(e.userId?e.userId===t.id:e.user===t.name)||(U(n=>[...n.filter(v=>v!==e.user),e.user]),O.current&&clearTimeout(O.current),O.current=setTimeout(()=>{U(n=>n.filter(I=>I!==e.user))},3e3));return}if(!(l&&!l(e))){if(e.type==="chat"&&e.user&&e.message){U(n=>(e.userId?e.userId===t.id:e.user===t.name)?n.filter(v=>v!==t.name):n.filter(v=>v!==e.user));const r={id:q(),user:e.user,message:e.message,timestamp:e.timestamp||Date.now(),userId:e.userId,avatarUrl:e.avatarUrl,type:e.messageType||"message"};A(n=>[...n,r])}u&&u(e)}},[l,u,t.name,t.id]),[,p]=W(a,Y,{credentials:m,instanceOptions:f});i.useEffect(()=>{E.current=p},[p]),i.useEffect(()=>{M.current=o},[o]),i.useEffect(()=>{p&&M.current&&M.current(p)},[p]),i.useEffect(()=>{g&&D.current&&D.current.scrollIntoView({behavior:"smooth"})},[h,g]);const J=i.useCallback(async()=>{if(w.trim()&&p&&!R){const e={type:"chat",user:t.name,message:w.trim(),timestamp:Date.now(),userId:t.id,avatarUrl:t.avatarUrl||void 0},r={id:q(),user:e.user,message:e.message,timestamp:e.timestamp,userId:e.userId,avatarUrl:e.avatarUrl,type:"message"};try{if(p(e,c),N&&V&&(await V(r),h.length>=S&&$)){const n=h.length+1-S;n>0&&await $(0,n)}K("")}catch(n){console.error("Failed to send message:",n)}}},[w,p,R,t,c,N,V,$,S,h.length]),z=e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),J())},B=e=>{K(e.target.value),E.current&&E.current({type:"typing",user:t.name,userId:t.id,timestamp:Date.now()})},F=C||((e,r,n)=>ee(e,r,y,j,t,n,T));return s.jsxs("div",{className:"vaultrice-chat",children:[s.jsxs("div",{className:"vaultrice-chat-messages",ref:P,children:[b?s.jsx("div",{className:"vaultrice-chat-loading",children:s.jsx("div",{className:"vaultrice-chat-loading-text",children:"Loading chat history..."})}):h.length===0?s.jsxs("div",{className:"vaultrice-chat-empty",children:[s.jsx("div",{className:"vaultrice-chat-empty-text",children:"No messages yet"}),s.jsx("div",{className:"vaultrice-chat-empty-subtext",children:"Start the conversation!"})]}):h.map((e,r)=>{const n=e.userId?e.userId===t.id:e.user===t.name,I=r>0?h[r-1]:null,v=H(e,I);return s.jsx("div",{children:F(e,n,v)},e.id)}),L.length>0&&s.jsx(te,{users:L}),s.jsx("div",{ref:D})]}),s.jsxs("div",{className:"vaultrice-chat-input-container",children:[s.jsx("input",{type:"text",className:"vaultrice-chat-input",value:w,onChange:B,onKeyDown:z,placeholder:d,disabled:R||!p||b}),s.jsx("button",{className:"vaultrice-chat-send-button",onClick:J,disabled:R||!w.trim()||!p||b,children:"Send"})]})]})};ae.__docgenInfo={description:"",methods:[],displayName:"Chat",props:{id:{required:!0,tsType:{name:"string"},description:""},user:{required:!0,tsType:{name:"User"},description:""},onMessage:{required:!1,tsType:{name:"signature",type:"function",raw:"(msg: JSONObj) => void",signature:{arguments:[{type:{name:"JSONObj"},name:"msg"}],return:{name:"void"}}},description:""},onSendReady:{required:!1,tsType:{name:"signature",type:"function",raw:"(send: (msg: any) => void) => void",signature:{arguments:[{type:{name:"signature",type:"function",raw:"(msg: any) => void",signature:{arguments:[{type:{name:"any"},name:"msg"}],return:{name:"void"}}},name:"send"}],return:{name:"void"}}},description:""},placeholder:{required:!1,tsType:{name:"string"},description:"",defaultValue:{value:"'Type a message...'",computed:!1}},showTimestamps:{required:!1,tsType:{name:"boolean"},description:"",defaultValue:{value:"true",computed:!1}},showUserAvatars:{required:!1,tsType:{name:"boolean"},description:"",defaultValue:{value:"true",computed:!1}},autoScroll:{required:!1,tsType:{name:"boolean"},description:"",defaultValue:{value:"true",computed:!1}},credentials:{required:!1,tsType:{name:"Credentials"},description:""},instanceOptions:{required:!1,tsType:{name:"InstanceOptions"},description:""},messageFilter:{required:!1,tsType:{name:"signature",type:"function",raw:"(msg: any) => boolean",signature:{arguments:[{type:{name:"any"},name:"msg"}],return:{name:"boolean"}}},description:""},renderMessage:{required:!1,tsType:{name:"signature",type:"function",raw:"(msg: ChatMessage, isOwnMessage: boolean) => ReactNode",signature:{arguments:[{type:{name:"ChatMessage"},name:"msg"},{type:{name:"boolean"},name:"isOwnMessage"}],return:{name:"ReactNode"}}},description:""},renderAvatar:{required:!1,tsType:{name:"signature",type:"function",raw:"(user: any, isOwnConnection?: boolean) => ReactNode",signature:{arguments:[{type:{name:"any"},name:"user"},{type:{name:"boolean"},name:"isOwnConnection"}],return:{name:"ReactNode"}}},description:"Custom avatar renderer function for chat messages."},disabled:{required:!1,tsType:{name:"boolean"},description:"",defaultValue:{value:"false",computed:!1}},persistMessages:{required:!1,tsType:{name:"boolean"},description:"If true, messages will be persisted using Vaultrice",defaultValue:{value:"false",computed:!1}},messageHistoryLimit:{required:!1,tsType:{name:"number"},description:"",defaultValue:{value:"100",computed:!1}},auth:{required:!1,tsType:{name:"UserAuthSettings"},description:"Optional object containing authentication credentials for user verification."}}};export{ae as C};
