import{j as s}from"./jsx-runtime-D_zvdyIk.js";import{r as c}from"./iframe-Fsy4Retp.js";import"./theme-ELSemj-T.js";import{e as F}from"./useNonLocalStorage-BcZ29QK1.js";import{o as H,d as P}from"./Presence-CGpS6P0O.js";const Q=(a,t,i)=>{const[u,p,o,,x,y,g]=F(a,t,i);return[p?.value||[],{push:async(d,f)=>{try{const l=await u.push(t,d,f);o(l)}catch(l){y(l)}},splice:async(d,f,l,C)=>{try{const j=await u.splice(t,d,f,l,C);o(j)}catch(j){y(j)}},setArray:async(d,f)=>{try{const l=await u.setItem(t,d,f);o(l)}catch(l){y(l)}}},x,g]};let R;typeof crypto<"u"&&typeof crypto.randomUUID=="function"?R=()=>crypto.randomUUID():R=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,a=>{const t=Math.random()*16|0;return(a==="x"?t:t&3|8).toString(16)});const W=(a,t=!0)=>{const i=new Date(a),u=new Date,p=i.toDateString()===u.toDateString();return p&&t?i.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):p?"Today":i.toLocaleDateString()},X=(a,t)=>{if(!t)return!1;const i=a.timestamp-t.timestamp,u=300*1e3;return a.user===t.user&&i<u},Z=(a,t,i,u,p,o=!1,x)=>{const y=t&&p?p:{name:a.user,avatarUrl:a.avatarUrl},g=t?"(You)":a.user,d=x||P;return s.jsxs("div",{className:`vaultrice-chat-message ${t?"vaultrice-chat-message-own":""} ${o?"vaultrice-chat-message-grouped":""}`,children:[i&&!o&&s.jsx("div",{className:"vaultrice-chat-avatar",children:d(y,t)}),i&&o&&s.jsx("div",{className:"vaultrice-chat-avatar vaultrice-chat-avatar-spacer"}),s.jsxs("div",{className:"vaultrice-chat-message-content",children:[!o&&s.jsx("div",{className:"vaultrice-chat-message-user",children:g}),s.jsx("div",{className:"vaultrice-chat-message-text",children:a.message}),u&&s.jsx("div",{className:"vaultrice-chat-message-timestamp",children:W(a.timestamp)})]})]})},G=({users:a})=>{if(a.length===0)return null;const t=a.length===1?`${a[0]} is typing...`:a.length===2?`${a[0]} and ${a[1]} are typing...`:`${a.slice(0,-1).join(", ")} and ${a[a.length-1]} are typing...`;return s.jsxs("div",{className:"vaultrice-chat-typing",children:[s.jsxs("div",{className:"vaultrice-chat-typing-dots",children:[s.jsx("span",{}),s.jsx("span",{}),s.jsx("span",{})]}),s.jsx("span",{className:"vaultrice-chat-typing-text",children:t})]})},ee=({id:a,user:t,onMessage:i,onSendReady:u,placeholder:p="Type a message...",maxHeight:o="400px",showTimestamps:x=!0,showUserAvatars:y=!0,autoScroll:g=!0,credentials:d,instanceOptions:f,messageFilter:l,renderMessage:C,renderAvatar:j,disabled:q=!1,persistMessages:T=!1,messageHistoryLimit:I=100})=>{const[h,$]=c.useState([]),[N,O]=c.useState(""),[A,U]=c.useState([]),D=c.useRef(null),L=c.useRef(null),M=c.useRef(u),S=c.useRef(null),k=c.useRef(null),[v,{push:V,splice:E},,w]=T?Q(a,"chat-history",{credentials:d,instanceOptions:f,bind:!1}):[[],{push:async()=>{},splice:async()=>{}},null,!1];c.useEffect(()=>{if(!(!T||w||!v||v.length===0)&&v&&Array.isArray(v)){const e=v.filter(n=>n&&typeof n=="object"&&"id"in n&&"user"in n&&"message"in n&&"timestamp"in n).sort((n,r)=>n.timestamp-r.timestamp);$(e)}},[T,v,w]);const J=c.useCallback(e=>{if(e.type==="typing"&&e.user!==t.name){U(n=>[...n.filter(b=>b!==e.user),e.user]),S.current&&clearTimeout(S.current),S.current=setTimeout(()=>{U(n=>n.filter(r=>r!==e.user))},3e3);return}if(!(l&&!l(e))){if(e.type==="chat"&&e.user&&e.message){U(r=>r.filter(b=>b!==e.user));const n={id:R(),user:e.user,message:e.message,timestamp:e.timestamp||Date.now(),userId:e.userId,avatarUrl:e.avatarUrl,type:e.messageType||"message"};$(r=>[...r,n])}i&&i(e)}},[l,i,t.name]),[,m]=H(a,J,{credentials:d,instanceOptions:f});c.useEffect(()=>{k.current=m},[m]),c.useEffect(()=>{M.current=u},[u]),c.useEffect(()=>{m&&M.current&&M.current(m)},[m]),c.useEffect(()=>{g&&D.current&&D.current.scrollIntoView({behavior:"smooth"})},[h,g]);const K=c.useCallback(async()=>{if(N.trim()&&m&&!q){const e={type:"chat",user:t.name,message:N.trim(),timestamp:Date.now(),userId:t.id,avatarUrl:t.avatarUrl||void 0},n={id:R(),user:e.user,message:e.message,timestamp:e.timestamp,userId:e.userId,avatarUrl:e.avatarUrl,type:"message"};try{if(m(e),T&&V&&(await V(n),h.length>=I&&E)){const r=h.length+1-I;r>0&&await E(0,r)}O("")}catch(r){console.error("Failed to send message:",r)}}},[N,m,q,t,T,V,E,I,h.length]),_=e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),K())},Y=e=>{O(e.target.value),k.current&&k.current({type:"typing",user:t.name,userId:t.id,timestamp:Date.now()})},z=C||((e,n,r)=>Z(e,n,y,x,t,r,j));return s.jsxs("div",{className:"vaultrice-chat",children:[s.jsxs("div",{className:"vaultrice-chat-messages",style:{maxHeight:o},ref:L,children:[w?s.jsx("div",{className:"vaultrice-chat-loading",children:s.jsx("div",{className:"vaultrice-chat-loading-text",children:"Loading chat history..."})}):h.length===0?s.jsxs("div",{className:"vaultrice-chat-empty",children:[s.jsx("div",{className:"vaultrice-chat-empty-text",children:"No messages yet"}),s.jsx("div",{className:"vaultrice-chat-empty-subtext",children:"Start the conversation!"})]}):h.map((e,n)=>{const r=e.user===t.name||e.userId===t.id,b=n>0?h[n-1]:null,B=X(e,b);return s.jsx("div",{children:z(e,r,B)},e.id)}),A.length>0&&s.jsx(G,{users:A}),s.jsx("div",{ref:D})]}),s.jsxs("div",{className:"vaultrice-chat-input-container",children:[s.jsx("input",{type:"text",className:"vaultrice-chat-input",value:N,onChange:Y,onKeyDown:_,placeholder:p,disabled:q||!m||w}),s.jsx("button",{className:"vaultrice-chat-send-button",onClick:K,disabled:q||!N.trim()||!m||w,children:"Send"})]})]})};ee.__docgenInfo={description:"",methods:[],displayName:"Chat",props:{id:{required:!0,tsType:{name:"string"},description:""},user:{required:!0,tsType:{name:"signature",type:"object",raw:`{
  name: string
  avatarUrl?: string
  id?: string
  [key: string]: any
}`,signature:{properties:[{key:"name",value:{name:"string",required:!0}},{key:"avatarUrl",value:{name:"string",required:!1}},{key:"id",value:{name:"string",required:!1}},{key:{name:"string"},value:{name:"any",required:!0}}]}},description:""},onMessage:{required:!1,tsType:{name:"signature",type:"function",raw:"(msg: JSONObj) => void",signature:{arguments:[{type:{name:"JSONObj"},name:"msg"}],return:{name:"void"}}},description:""},onSendReady:{required:!1,tsType:{name:"signature",type:"function",raw:"(send: (msg: any) => void) => void",signature:{arguments:[{type:{name:"signature",type:"function",raw:"(msg: any) => void",signature:{arguments:[{type:{name:"any"},name:"msg"}],return:{name:"void"}}},name:"send"}],return:{name:"void"}}},description:""},placeholder:{required:!1,tsType:{name:"string"},description:"",defaultValue:{value:"'Type a message...'",computed:!1}},maxHeight:{required:!1,tsType:{name:"string"},description:"",defaultValue:{value:"'400px'",computed:!1}},showTimestamps:{required:!1,tsType:{name:"boolean"},description:"",defaultValue:{value:"true",computed:!1}},showUserAvatars:{required:!1,tsType:{name:"boolean"},description:"",defaultValue:{value:"true",computed:!1}},autoScroll:{required:!1,tsType:{name:"boolean"},description:"",defaultValue:{value:"true",computed:!1}},credentials:{required:!1,tsType:{name:"Credentials"},description:""},instanceOptions:{required:!1,tsType:{name:"InstanceOptions"},description:""},messageFilter:{required:!1,tsType:{name:"signature",type:"function",raw:"(msg: any) => boolean",signature:{arguments:[{type:{name:"any"},name:"msg"}],return:{name:"boolean"}}},description:""},renderMessage:{required:!1,tsType:{name:"signature",type:"function",raw:"(msg: ChatMessage, isOwnMessage: boolean) => ReactNode",signature:{arguments:[{type:{name:"ChatMessage"},name:"msg"},{type:{name:"boolean"},name:"isOwnMessage"}],return:{name:"ReactNode"}}},description:""},renderAvatar:{required:!1,tsType:{name:"signature",type:"function",raw:"(user: any, isOwnConnection?: boolean) => ReactNode",signature:{arguments:[{type:{name:"any"},name:"user"},{type:{name:"boolean"},name:"isOwnConnection"}],return:{name:"ReactNode"}}},description:"Custom avatar renderer function for chat messages."},disabled:{required:!1,tsType:{name:"boolean"},description:"",defaultValue:{value:"false",computed:!1}},persistMessages:{required:!1,tsType:{name:"boolean"},description:"If true, messages will be persisted using Vaultrice",defaultValue:{value:"false",computed:!1}},messageHistoryLimit:{required:!1,tsType:{name:"number"},description:"Maximum number of messages to keep in persistent history (default: 100)",defaultValue:{value:"100",computed:!1}}}};export{ee as C};
