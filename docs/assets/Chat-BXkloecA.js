import{j as s}from"./jsx-runtime-D_zvdyIk.js";import{r as i}from"./iframe-QT8oHMxz.js";import"./theme-XIYBvMck.js";import{e as F}from"./useNonLocalStorage-DTUqfFwM.js";import{o as Q,d as W}from"./Presence-CNF3E5M3.js";const X=(a,t,c)=>{const[u,p,o,,j,y,v]=F(a,t,c);return[p?.value||[],{push:async(d,f)=>{try{const l=await u.push(t,d,f);o(l)}catch(l){y(l)}},splice:async(d,f,l,R)=>{try{const g=await u.splice(t,d,f,l,R);o(g)}catch(g){y(g)}},setArray:async(d,f)=>{try{const l=await u.setItem(t,d,f);o(l)}catch(l){y(l)}}},j,v]};let q;typeof crypto<"u"&&typeof crypto.randomUUID=="function"?q=()=>crypto.randomUUID():q=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,a=>{const t=Math.random()*16|0;return(a==="x"?t:t&3|8).toString(16)});const Z=(a,t=!0)=>{const c=new Date(a),u=new Date,p=c.toDateString()===u.toDateString();return p&&t?c.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):p?"Today":c.toLocaleDateString()},G=(a,t)=>{if(!t)return!1;const c=a.timestamp-t.timestamp,u=300*1e3;return a.user===t.user&&c<u},H=(a,t,c,u,p,o=!1,j)=>{const y=t&&p?p:{name:a.user,avatarUrl:a.avatarUrl},v=t?"(You)":a.user,d=j||W;return s.jsxs("div",{className:`vaultrice-chat-message ${t?"vaultrice-chat-message-own":""} ${o?"vaultrice-chat-message-grouped":""}`,children:[c&&!o&&s.jsx("div",{className:"vaultrice-chat-avatar",children:d(y,t)}),c&&o&&s.jsx("div",{className:"vaultrice-chat-avatar vaultrice-chat-avatar-spacer"}),s.jsxs("div",{className:"vaultrice-chat-message-content",children:[!o&&s.jsx("div",{className:"vaultrice-chat-message-user",children:v}),s.jsx("div",{className:"vaultrice-chat-message-text",children:a.message}),u&&s.jsx("div",{className:"vaultrice-chat-message-timestamp",children:Z(a.timestamp)})]})]})},ee=({users:a})=>{if(a.length===0)return null;const t=a.length===1?`${a[0]} is typing...`:a.length===2?`${a[0]} and ${a[1]} are typing...`:`${a.slice(0,-1).join(", ")} and ${a[a.length-1]} are typing...`;return s.jsxs("div",{className:"vaultrice-chat-typing",children:[s.jsxs("div",{className:"vaultrice-chat-typing-dots",children:[s.jsx("span",{}),s.jsx("span",{}),s.jsx("span",{})]}),s.jsx("span",{className:"vaultrice-chat-typing-text",children:t})]})},te=({id:a,user:t,onMessage:c,onSendReady:u,placeholder:p="Type a message...",showTimestamps:o=!0,showUserAvatars:j=!0,autoScroll:y=!0,credentials:v,instanceOptions:d,messageFilter:f,renderMessage:l,renderAvatar:R,disabled:g=!1,persistMessages:T=!1,messageHistoryLimit:C=100})=>{const[h,O]=i.useState([]),[V,L]=i.useState(!1),[N,$]=i.useState(""),[A,I]=i.useState([]),U=i.useRef(null),J=i.useRef(null),D=i.useRef(u),S=i.useRef(null),M=i.useRef(null),[x,{push:k,splice:E},,w]=T?X(a,"chat-history",{credentials:v,instanceOptions:d,bind:!1}):[[],{push:async()=>{},splice:async()=>{}},null,!1];i.useEffect(()=>{if(!(V||!T||w||!x||x.length===0)&&x&&Array.isArray(x)){const e=x.filter(n=>n&&typeof n=="object"&&"id"in n&&"user"in n&&"message"in n&&"timestamp"in n).sort((n,r)=>n.timestamp-r.timestamp);O(e),L(!0)}},[T,x,w,V]);const _=i.useCallback(e=>{if(e.type==="typing"&&e.user!==t.name){I(n=>[...n.filter(b=>b!==e.user),e.user]),S.current&&clearTimeout(S.current),S.current=setTimeout(()=>{I(n=>n.filter(r=>r!==e.user))},3e3);return}if(!(f&&!f(e))){if(e.type==="chat"&&e.user&&e.message){I(r=>r.filter(b=>b!==e.user));const n={id:q(),user:e.user,message:e.message,timestamp:e.timestamp||Date.now(),userId:e.userId,avatarUrl:e.avatarUrl,type:e.messageType||"message"};O(r=>[...r,n])}c&&c(e)}},[f,c,t.name]),[,m]=Q(a,_,{credentials:v,instanceOptions:d});i.useEffect(()=>{M.current=m},[m]),i.useEffect(()=>{D.current=u},[u]),i.useEffect(()=>{m&&D.current&&D.current(m)},[m]),i.useEffect(()=>{y&&U.current&&U.current.scrollIntoView({behavior:"smooth"})},[h,y]);const K=i.useCallback(async()=>{if(N.trim()&&m&&!g){const e={type:"chat",user:t.name,message:N.trim(),timestamp:Date.now(),userId:t.id,avatarUrl:t.avatarUrl||void 0},n={id:q(),user:e.user,message:e.message,timestamp:e.timestamp,userId:e.userId,avatarUrl:e.avatarUrl,type:"message"};try{if(m(e),T&&k&&(await k(n),h.length>=C&&E)){const r=h.length+1-C;r>0&&await E(0,r)}$("")}catch(r){console.error("Failed to send message:",r)}}},[N,m,g,t,T,k,E,C,h.length]),P=e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),K())},Y=e=>{$(e.target.value),M.current&&M.current({type:"typing",user:t.name,userId:t.id,timestamp:Date.now()})},z=l||((e,n,r)=>H(e,n,j,o,t,r,R));return s.jsxs("div",{className:"vaultrice-chat",children:[s.jsxs("div",{className:"vaultrice-chat-messages",ref:J,children:[w?s.jsx("div",{className:"vaultrice-chat-loading",children:s.jsx("div",{className:"vaultrice-chat-loading-text",children:"Loading chat history..."})}):h.length===0?s.jsxs("div",{className:"vaultrice-chat-empty",children:[s.jsx("div",{className:"vaultrice-chat-empty-text",children:"No messages yet"}),s.jsx("div",{className:"vaultrice-chat-empty-subtext",children:"Start the conversation!"})]}):h.map((e,n)=>{const r=e.user===t.name||e.userId===t.id,b=n>0?h[n-1]:null,B=G(e,b);return s.jsx("div",{children:z(e,r,B)},e.id)}),A.length>0&&s.jsx(ee,{users:A}),s.jsx("div",{ref:U})]}),s.jsxs("div",{className:"vaultrice-chat-input-container",children:[s.jsx("input",{type:"text",className:"vaultrice-chat-input",value:N,onChange:Y,onKeyDown:P,placeholder:p,disabled:g||!m||w}),s.jsx("button",{className:"vaultrice-chat-send-button",onClick:K,disabled:g||!N.trim()||!m||w,children:"Send"})]})]})};te.__docgenInfo={description:"",methods:[],displayName:"Chat",props:{id:{required:!0,tsType:{name:"string"},description:""},user:{required:!0,tsType:{name:"signature",type:"object",raw:`{
  name: string
  avatarUrl?: string
  id?: string
  [key: string]: any
}`,signature:{properties:[{key:"name",value:{name:"string",required:!0}},{key:"avatarUrl",value:{name:"string",required:!1}},{key:"id",value:{name:"string",required:!1}},{key:{name:"string"},value:{name:"any",required:!0}}]}},description:""},onMessage:{required:!1,tsType:{name:"signature",type:"function",raw:"(msg: JSONObj) => void",signature:{arguments:[{type:{name:"JSONObj"},name:"msg"}],return:{name:"void"}}},description:""},onSendReady:{required:!1,tsType:{name:"signature",type:"function",raw:"(send: (msg: any) => void) => void",signature:{arguments:[{type:{name:"signature",type:"function",raw:"(msg: any) => void",signature:{arguments:[{type:{name:"any"},name:"msg"}],return:{name:"void"}}},name:"send"}],return:{name:"void"}}},description:""},placeholder:{required:!1,tsType:{name:"string"},description:"",defaultValue:{value:"'Type a message...'",computed:!1}},showTimestamps:{required:!1,tsType:{name:"boolean"},description:"",defaultValue:{value:"true",computed:!1}},showUserAvatars:{required:!1,tsType:{name:"boolean"},description:"",defaultValue:{value:"true",computed:!1}},autoScroll:{required:!1,tsType:{name:"boolean"},description:"",defaultValue:{value:"true",computed:!1}},credentials:{required:!1,tsType:{name:"Credentials"},description:""},instanceOptions:{required:!1,tsType:{name:"InstanceOptions"},description:""},messageFilter:{required:!1,tsType:{name:"signature",type:"function",raw:"(msg: any) => boolean",signature:{arguments:[{type:{name:"any"},name:"msg"}],return:{name:"boolean"}}},description:""},renderMessage:{required:!1,tsType:{name:"signature",type:"function",raw:"(msg: ChatMessage, isOwnMessage: boolean) => ReactNode",signature:{arguments:[{type:{name:"ChatMessage"},name:"msg"},{type:{name:"boolean"},name:"isOwnMessage"}],return:{name:"ReactNode"}}},description:""},renderAvatar:{required:!1,tsType:{name:"signature",type:"function",raw:"(user: any, isOwnConnection?: boolean) => ReactNode",signature:{arguments:[{type:{name:"any"},name:"user"},{type:{name:"boolean"},name:"isOwnConnection"}],return:{name:"ReactNode"}}},description:"Custom avatar renderer function for chat messages."},disabled:{required:!1,tsType:{name:"boolean"},description:"",defaultValue:{value:"false",computed:!1}},persistMessages:{required:!1,tsType:{name:"boolean"},description:"If true, messages will be persisted using Vaultrice",defaultValue:{value:"false",computed:!1}},messageHistoryLimit:{required:!1,tsType:{name:"number"},description:"",defaultValue:{value:"100",computed:!1}}}};export{te as C};
