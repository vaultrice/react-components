import{j as s}from"./jsx-runtime-D_zvdyIk.js";import{r as c}from"./iframe-h-Gz1dj-.js";import"./theme-ELSemj-T.js";import{e as B}from"./useNonLocalStorage-w7ePNe5P.js";import{o as F,d as P}from"./Presence-B7JugaS8.js";const Q=(a,t,i)=>{const[l,p,o,,j,y,v]=B(a,t,i);return[p?.value||[],{push:async(d,f)=>{try{const u=await l.push(t,d,f);o(u)}catch(u){y(u)}},splice:async(d,f,u,R)=>{try{const h=await l.splice(t,d,f,u,R);o(h)}catch(h){y(h)}},setArray:async(d,f)=>{try{const u=await l.setItem(t,d,f);o(u)}catch(u){y(u)}}},j,v]};let q;typeof crypto<"u"&&typeof crypto.randomUUID=="function"?q=()=>crypto.randomUUID():q=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,a=>{const t=Math.random()*16|0;return(a==="x"?t:t&3|8).toString(16)});const W=(a,t=!0)=>{const i=new Date(a),l=new Date,p=i.toDateString()===l.toDateString();return p&&t?i.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):p?"Today":i.toLocaleDateString()},X=(a,t)=>{if(!t)return!1;const i=a.timestamp-t.timestamp,l=300*1e3;return a.user===t.user&&i<l},Z=(a,t,i,l,p,o=!1,j)=>{const y=t&&p?p:{name:a.user,avatarUrl:a.avatarUrl},v=t?"(You)":a.user,d=j||P;return s.jsxs("div",{className:`vaultrice-chat-message ${t?"vaultrice-chat-message-own":""} ${o?"vaultrice-chat-message-grouped":""}`,children:[i&&!o&&s.jsx("div",{className:"vaultrice-chat-avatar",children:d(y,t)}),i&&o&&s.jsx("div",{className:"vaultrice-chat-avatar vaultrice-chat-avatar-spacer"}),s.jsxs("div",{className:"vaultrice-chat-message-content",children:[!o&&s.jsx("div",{className:"vaultrice-chat-message-user",children:v}),s.jsx("div",{className:"vaultrice-chat-message-text",children:a.message}),l&&s.jsx("div",{className:"vaultrice-chat-message-timestamp",children:W(a.timestamp)})]})]})},G=({users:a})=>{if(a.length===0)return null;const t=a.length===1?`${a[0]} is typing...`:a.length===2?`${a[0]} and ${a[1]} are typing...`:`${a.slice(0,-1).join(", ")} and ${a[a.length-1]} are typing...`;return s.jsxs("div",{className:"vaultrice-chat-typing",children:[s.jsxs("div",{className:"vaultrice-chat-typing-dots",children:[s.jsx("span",{}),s.jsx("span",{}),s.jsx("span",{})]}),s.jsx("span",{className:"vaultrice-chat-typing-text",children:t})]})},H=({id:a,user:t,onMessage:i,onSendReady:l,placeholder:p="Type a message...",showTimestamps:o=!0,showUserAvatars:j=!0,autoScroll:y=!0,credentials:v,instanceOptions:d,messageFilter:f,renderMessage:u,renderAvatar:R,disabled:h=!1,persistMessages:T=!1,messageHistoryLimit:C=100})=>{const[g,V]=c.useState([]),[N,$]=c.useState(""),[O,I]=c.useState([]),U=c.useRef(null),K=c.useRef(null),D=c.useRef(l),M=c.useRef(null),S=c.useRef(null),[x,{push:k,splice:E},,w]=T?Q(a,"chat-history",{credentials:v,instanceOptions:d,bind:!1}):[[],{push:async()=>{},splice:async()=>{}},null,!1];c.useEffect(()=>{if(!(!T||w||!x||x.length===0)&&x&&Array.isArray(x)){const e=x.filter(n=>n&&typeof n=="object"&&"id"in n&&"user"in n&&"message"in n&&"timestamp"in n).sort((n,r)=>n.timestamp-r.timestamp);V(e)}},[T,x,w]);const L=c.useCallback(e=>{if(e.type==="typing"&&e.user!==t.name){I(n=>[...n.filter(b=>b!==e.user),e.user]),M.current&&clearTimeout(M.current),M.current=setTimeout(()=>{I(n=>n.filter(r=>r!==e.user))},3e3);return}if(!(f&&!f(e))){if(e.type==="chat"&&e.user&&e.message){I(r=>r.filter(b=>b!==e.user));const n={id:q(),user:e.user,message:e.message,timestamp:e.timestamp||Date.now(),userId:e.userId,avatarUrl:e.avatarUrl,type:e.messageType||"message"};V(r=>[...r,n])}i&&i(e)}},[f,i,t.name]),[,m]=F(a,L,{credentials:v,instanceOptions:d});c.useEffect(()=>{S.current=m},[m]),c.useEffect(()=>{D.current=l},[l]),c.useEffect(()=>{m&&D.current&&D.current(m)},[m]),c.useEffect(()=>{y&&U.current&&U.current.scrollIntoView({behavior:"smooth"})},[g,y]);const A=c.useCallback(async()=>{if(N.trim()&&m&&!h){const e={type:"chat",user:t.name,message:N.trim(),timestamp:Date.now(),userId:t.id,avatarUrl:t.avatarUrl||void 0},n={id:q(),user:e.user,message:e.message,timestamp:e.timestamp,userId:e.userId,avatarUrl:e.avatarUrl,type:"message"};try{if(m(e),T&&k&&(await k(n),g.length>=C&&E)){const r=g.length+1-C;r>0&&await E(0,r)}$("")}catch(r){console.error("Failed to send message:",r)}}},[N,m,h,t,T,k,E,C,g.length]),J=e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),A())},_=e=>{$(e.target.value),S.current&&S.current({type:"typing",user:t.name,userId:t.id,timestamp:Date.now()})},Y=u||((e,n,r)=>Z(e,n,j,o,t,r,R));return s.jsxs("div",{className:"vaultrice-chat",children:[s.jsxs("div",{className:"vaultrice-chat-messages",ref:K,children:[w?s.jsx("div",{className:"vaultrice-chat-loading",children:s.jsx("div",{className:"vaultrice-chat-loading-text",children:"Loading chat history..."})}):g.length===0?s.jsxs("div",{className:"vaultrice-chat-empty",children:[s.jsx("div",{className:"vaultrice-chat-empty-text",children:"No messages yet"}),s.jsx("div",{className:"vaultrice-chat-empty-subtext",children:"Start the conversation!"})]}):g.map((e,n)=>{const r=e.user===t.name||e.userId===t.id,b=n>0?g[n-1]:null,z=X(e,b);return s.jsx("div",{children:Y(e,r,z)},e.id)}),O.length>0&&s.jsx(G,{users:O}),s.jsx("div",{ref:U})]}),s.jsxs("div",{className:"vaultrice-chat-input-container",children:[s.jsx("input",{type:"text",className:"vaultrice-chat-input",value:N,onChange:_,onKeyDown:J,placeholder:p,disabled:h||!m||w}),s.jsx("button",{className:"vaultrice-chat-send-button",onClick:A,disabled:h||!N.trim()||!m||w,children:"Send"})]})]})};H.__docgenInfo={description:"",methods:[],displayName:"Chat",props:{id:{required:!0,tsType:{name:"string"},description:""},user:{required:!0,tsType:{name:"signature",type:"object",raw:`{
  name: string
  avatarUrl?: string
  id?: string
  [key: string]: any
}`,signature:{properties:[{key:"name",value:{name:"string",required:!0}},{key:"avatarUrl",value:{name:"string",required:!1}},{key:"id",value:{name:"string",required:!1}},{key:{name:"string"},value:{name:"any",required:!0}}]}},description:""},onMessage:{required:!1,tsType:{name:"signature",type:"function",raw:"(msg: JSONObj) => void",signature:{arguments:[{type:{name:"JSONObj"},name:"msg"}],return:{name:"void"}}},description:""},onSendReady:{required:!1,tsType:{name:"signature",type:"function",raw:"(send: (msg: any) => void) => void",signature:{arguments:[{type:{name:"signature",type:"function",raw:"(msg: any) => void",signature:{arguments:[{type:{name:"any"},name:"msg"}],return:{name:"void"}}},name:"send"}],return:{name:"void"}}},description:""},placeholder:{required:!1,tsType:{name:"string"},description:"",defaultValue:{value:"'Type a message...'",computed:!1}},showTimestamps:{required:!1,tsType:{name:"boolean"},description:"",defaultValue:{value:"true",computed:!1}},showUserAvatars:{required:!1,tsType:{name:"boolean"},description:"",defaultValue:{value:"true",computed:!1}},autoScroll:{required:!1,tsType:{name:"boolean"},description:"",defaultValue:{value:"true",computed:!1}},credentials:{required:!1,tsType:{name:"Credentials"},description:""},instanceOptions:{required:!1,tsType:{name:"InstanceOptions"},description:""},messageFilter:{required:!1,tsType:{name:"signature",type:"function",raw:"(msg: any) => boolean",signature:{arguments:[{type:{name:"any"},name:"msg"}],return:{name:"boolean"}}},description:""},renderMessage:{required:!1,tsType:{name:"signature",type:"function",raw:"(msg: ChatMessage, isOwnMessage: boolean) => ReactNode",signature:{arguments:[{type:{name:"ChatMessage"},name:"msg"},{type:{name:"boolean"},name:"isOwnMessage"}],return:{name:"ReactNode"}}},description:""},renderAvatar:{required:!1,tsType:{name:"signature",type:"function",raw:"(user: any, isOwnConnection?: boolean) => ReactNode",signature:{arguments:[{type:{name:"any"},name:"user"},{type:{name:"boolean"},name:"isOwnConnection"}],return:{name:"ReactNode"}}},description:"Custom avatar renderer function for chat messages."},disabled:{required:!1,tsType:{name:"boolean"},description:"",defaultValue:{value:"false",computed:!1}},persistMessages:{required:!1,tsType:{name:"boolean"},description:"If true, messages will be persisted using Vaultrice",defaultValue:{value:"false",computed:!1}},messageHistoryLimit:{required:!1,tsType:{name:"number"},description:"",defaultValue:{value:"100",computed:!1}}}};export{H as C};
